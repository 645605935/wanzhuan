<?phpnamespace Admin\Controller;use Common\Controller\AuthController;class CompanyController extends AuthController {        public function _initialize() {        parent::_initialize();        global $user;        $user=session('auth');        $this->user=$user;        $this->cur_c='Company';    }        public function index(){        global $user;        $this->user=$user;        $d =D('Company');        $map=array();        $count      = $d->where($map)->count();        $Page       = new \Common\Extend\Page($count,20);        $nowPage = isset($_GET['p'])?$_GET['p']:1;        $list = $d->order('id desc')->where($map)->page($nowPage.','.$Page->listRows)->select();        $show       = $Page->show();        $this->assign('page',$show);        $this->assign('list',$list);        $this->cur_c='Company-index';        $this->display();    }    public function add(){        global $user;        $this->user=$user;        if(IS_POST){            if(!$_POST['title']){$this->error('标题不能为空');exit;};            $d=D('Company');            $data=$d->create();            $data['time']       =NOW_TIME;            if($id=$d->add($data)){                if($_FILES['img']['size']>0){                    $image=new \Common\Extend\Image();                    $img=$image->upload($_FILES['img'],filePath($id,'company'),'thumb');                    $update['img']      =$img['origin_'];                    $update['id']=$id;                    $d->save($update);                }                // 日志记录  start                $url = MODULE_NAME."/".CONTROLLER_NAME."/".ACTION_NAME;                $model=MODULE_NAME;                $controller=CONTROLLER_NAME;                $action=ACTION_NAME;                $title = D('AuthRule')->field('title')->where(array('name'=>$url))->find();                if(!$title){$title['title']="暂无规则";}                D('Log')->addLog($title,$url,$model,$controller,$action);                // 日志记录  end                $this->success('添加成功',U('Admin/Company/index'));            }else{                $this->error('添加失败');            }        }else{            $this->cur_c='Company-add';            $this->display();        }    }    public function edit(){        global $user;        $this->user=$user;        if(IS_POST){            if(!$_POST['title']){$this->error('标题不能为空');exit;};            $d=D('Company');                    $data=$d->create();            if($_FILES['img']['size']>0){                $image=new \Common\Extend\Image();                $img=$image->upload($_FILES['img'],filePath($data['id'],'company'),'thumb');                $data['img']    =$img['origin_'];            }else{                unset($data['img']);            }            if($d->save($data)){                // 日志记录  start                $url = MODULE_NAME."/".CONTROLLER_NAME."/".ACTION_NAME;                $model=MODULE_NAME;                $controller=CONTROLLER_NAME;                $action=ACTION_NAME;                $title = D('AuthRule')->field('title')->where(array('name'=>$url))->find();                if(!$title){$title['title']="暂无规则";}                D('Log')->addLog($title,$url,$model,$controller,$action);                // 日志记录  end                $this->success('编辑成功',U('Admin/Company/index'));            }else{                $this->error('编辑失败');            }        }else{            $this->row=M('Company')->where('id='.$_GET['id'])->find();            $this->cur_c='Company-edit';            $this->display();        }    }    //删除    public function del(){        if($ids=I('post.ids')){            if(is_array($ids)){                $map['id']=array('in',implode(',', $ids ));                $result=M('Company')->where($map)->delete();                foreach ($ids as  $id) {                    $dir=STATIC_PATH.filePath2($id,'company');                    delDir( $dir );                }            }else{                $map['id'] = $ids;                $result=M('Company')->where($map)->delete();                $dir=STATIC_PATH.filePath2($ids,'company');                delDir( $dir );            }            // 日志记录  start            $url = MODULE_NAME."/".CONTROLLER_NAME."/".ACTION_NAME;            $model=MODULE_NAME;            $controller=CONTROLLER_NAME;            $action=ACTION_NAME;            $title = D('AuthRule')->field('title')->where(array('name'=>$url))->find();            if(!$title){$title['title']="暂无规则";}            D('Log')->addLog($title,$url,$model,$controller,$action);            // 日志记录  end            $txt='删除成功';        }else{            $txt='删除失败';        }        echo json_encode(array('txt'=>$txt));    }    //禁用    public function lock(){        if(I('get.id')){            $data['id']=I('id');            $data['status']=1;            if(M('Company')->save($data)){                // 日志记录  start                $url = MODULE_NAME."/".CONTROLLER_NAME."/".ACTION_NAME;                $model=MODULE_NAME;                $controller=CONTROLLER_NAME;                $action=ACTION_NAME;                $title = D('AuthRule')->field('title')->where(array('name'=>$url))->find();                if(!$title){$title['title']="暂无规则";}                D('Log')->addLog($title,$url,$model,$controller,$action);                // 日志记录  end                                $this->success("禁用成功");            }else{                $this->success("禁用失败");            }        }    }}?>